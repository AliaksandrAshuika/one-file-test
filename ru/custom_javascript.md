---
"$title": Создайте виджет пользовательского интерфейса с помощью пользовательского JavaScript
"$order": '101'
formats:
- веб-сайты
tutorial: правда
author:
- морссссс
- CrystalOnScript
description: Для веб-приложений, требующих большого количества настроек, AMP создал amp-script, компонент, который позволяет использовать произвольный JavaScript на вашей странице AMP, не влияя на производительность страницы.
---

В этом руководстве вы узнаете, как использовать `<amp-script>` , компонент, который позволяет разработчикам писать собственный JavaScript в AMP. Вы будете использовать это для создания виджета, который проверяет содержимое поля ввода пароля, разрешая его отправку только при соблюдении определенных требований. AMP уже предоставляет эту функциональность с помощью `<amp-form>` , но `<amp-script>` позволит вам создать индивидуальный интерфейс.

## Что вам понадобится

- Современный веб-браузер
- Базовые знания HTML, CSS и JavaScript
- Либо:
    - локальный веб-сервер и редактор кода, например [SublimeText](https://www.sublimetext.com) или [VSCode](https://code.visualstudio.com/)
    - *или* [CodePen](https://codepen.io/) , [Glitch](https://glitch.com/) или аналогичную онлайн-площадку

## Задний план

AMP стремится сделать веб-сайты более быстрыми и стабильными для пользователей. Избыточный JavaScript может замедлить работу веб-страницы. Но иногда вам нужно создать функциональность, которую компоненты AMP не предоставляют. В таких случаях вы можете использовать компонент [`<amp-script>`](../../../documentation/components/reference/amp-script.md) для написания пользовательского JavaScript.

Давайте начнем!

# Начиная

Чтобы получить стартовый код, скачайте или клонируйте[этот репозиторий на github](https://github.com/ampproject/samples/tree/master/amp-script-tutorial) . Как только вы это сделаете, `cd` в созданный вами каталог. Вы увидите два каталога: `starter_code` и `finished_code` . `finished_code` содержит то, что вы создадите в ходе этого руководства. Так что не будем пока на это смотреть. Вместо этого `cd` в `starter_code` . Он содержит веб-страницу, которая реализует нашу форму, используя только [`<amp-form>`](../../../documentation/components/reference/amp-form.md) , без помощи `<amp-script>` .

Для выполнения этого упражнения вам необходимо запустить веб-сервер на вашем компьютере. Если вы уже делаете это, все будет готово! В таком случае, в зависимости от ваших настроек, вы сможете получить доступ к начальной веб-странице, введя в свой браузер URL-адрес, например `http://localhost/amp-script-tutorial/starter_code/index.html` .

В качестве альтернативы вы можете настроить быстрый локальный сервер, используя что-то вроде [serve](https://www.npmjs.com/package/serve) , сервера статического содержимого на основе [Node.js.](https://nodejs.org/) Если вы еще не установили Node.js, скачайте его [здесь](https://nodejs.org/) . После установки Node введите в командной строке `npx serve` . Затем вы можете получить доступ к своему веб-сайту здесь:

`http://localhost:5000/`

Вы также можете использовать онлайн-площадку, такую как [Glitch](https://glitch.com/) или [CodePen](https://codepen.io/) . <a href="itch%5D(https://glitch.com/~grove-thankful-ragdoll" target="_blank">Он</a> содержит тот же код, что и репозиторий github, и вы можете начать с него, если хотите!

Как только вы это сделаете, вы увидите нашу стартовую веб-страницу:

{{image ('/ static / img / docs / tutorials / custom-javascript-tutorial / starter-form.jpg', 600, 325, layout = 'intrinsic', alt = 'Веб-форма с вводом электронной почты и пароля', выровняйте = 'центр')}}

Откройте `starter_code/index.html` в своем любимом редакторе кода. Взгляните на HTML для этой формы. Обратите внимание, что пароль `<input>` содержит этот атрибут:

```html
on="tap:rules.show; input-debounced:rules.show"
```

Это указывает AMP показывать правила `<div>` когда пользователь нажимает или нажимает пароль `<input>` , а также после ввода любого символа в него. Мы бы предпочли использовать событие `focus` , которое также охватило бы случай, когда пользователь переходит на вкладку ввода. По крайней мере, на момент написания этого руководства AMP не передает это событие, поэтому у нас нет этой опции. Не волнуйся. Мы собираемся исправить это с помощью `<amp-script>` !

Пароль `<input>` содержит еще один интересный атрибут:

```html
pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^a-z\d]).{8,}$"
```

Это регулярное выражение объединяет набор более мелких регулярных выражений, каждое из которых выражает одно из наших правил проверки. AMP [не позволит отправить форму](../../../documentation/components/reference/amp-form.md#verification) до тех пор, пока содержимое входного файла не совпадет. Если пользователь попытается, он увидит сообщение об ошибке с некоторыми подробностями:

{{image ('/ static / img / docs / tutorials / custom-javascript-tutorial / starter-form-error.jpg', 600, 442, layout = 'intrinsic', alt = 'Веб-форма, показывающая сообщение об ошибке', выровняйте = 'центр')}}

[tip type = "note"] Поскольку код, который мы вам предоставили, не включает веб-сервис, который обрабатывает отправку форм, отправка формы не принесет никакой пользы. Конечно, вы можете добавить эту функцию в свой собственный код! [/наконечник]

Это приемлемо, но, к сожалению, AMP не может объяснить, какое из наших правил проверки не удалось. Он не может знать, поскольку нам пришлось свести правила в одно регулярное выражение.

Теперь давайте воспользуемся `<amp-script>` чтобы сделать работу удобнее!

# Восстановить это с<amp-script></amp-script>

Чтобы использовать `<amp-script>` , нам нужно импортировать собственный JavaScript. Откройте `index.html` и добавьте следующее в `<head>` .

```html
<head>
 ...
  <script async custom-element="amp-script" src="https://cdn.ampproject.org/v0/amp-script-0.1.js"></script>
  ...
</head>

```

`<amp-script>` позволяет нам писать наш собственный JavaScript встроенный или во внешний файл. В этом упражнении мы напишем достаточно кода, чтобы выделить его в отдельный файл. Создайте новый каталог с именем `js` и добавьте в него новый файл с именем `validate.js` .

`<amp-script>` позволяет вашему JavaScript манипулировать своими дочерними элементами DOM - элементами, которые включает компонент. Он копирует эти дочерние DOM в виртуальную DOM и предоставляет вашему коду доступ к этой виртуальной DOM. В этом упражнении мы хотим, чтобы наш JavaScript управлял нашей `<form>` и ее содержимым. Итак, мы заключим `<form>` в компонент `<amp-script>` , например:

```html
<amp-script src="js/validate.js" layout="fixed" sandbox="allow-forms" height="500" width="750">
  <form method="post" action-xhr="#" target="_top" class="card">
    ...
  </form>
</amp-script>
```

Наш `<amp-script>` включает атрибут `sandbox="allow-forms"` . Это говорит AMP, что скрипт может изменять содержимое формы.

Поскольку AMP стремится гарантировать быстрое и визуально стабильное взаимодействие с пользователем, он не позволит нашему JavaScript вносить неограниченные изменения в DOM в любое время. Ваш JavaScript может внести больше изменений, если размер компонента `<amp-script>` не может измениться. Это также позволяет вносить более существенные изменения после взаимодействия с пользователем. Подробности можно найти в [справочной документации](../../../documentation/components/reference/amp-script.md) . Для этого руководства достаточно знать, что мы указали тип `layout` который не является `container` , и мы использовали атрибуты HTML для ограничения размера компонента. Это означает, что любые манипуляции с DOM ограничены определенной областью страницы.

Если вы используете [расширение Chrome для проверки AMP,](https://chrome.google.com/webstore/detail/amp-validator/nmoffdblmcmgeicmolmhobpoocbbmknc) вы увидите сообщение об ошибке:

{{image ('/ static / img / docs / tutorials / custom-javascript-tutorial / relative-url-error.png', 600, 177, layout = 'intrinsic', alt = 'Ошибка относительно относительного URL', align = 'center')}}

[tip type = "note"] Если у вас нет этого расширения, добавьте `#development=1` к своему URL-адресу, и AMP будет выводить ошибки проверки в вашу консоль. [/наконечник]

Что это значит? Если ваш `<amp-script>` загружает свой JavaScript из внешнего файла, AMP требует, чтобы вы указали абсолютный URL. Мы могли бы исправить это, используя `http://localhost/js/validate.js` . Но AMP также требует использования [HTTPS](https://developers.google.com/web/fundamentals/security/encrypt-in-transit/why-https) . Таким образом, мы все равно получим ошибку проверки, а настройка SSL на нашем локальном веб-сервере выходит за рамки этого руководства. Если вы хотите это сделать, вы можете следовать инструкциям в [этом посте](https://timonweb.com/posts/running-expressjs-server-over-https/) .

Затем мы можем удалить атрибут `pattern` и его регулярное выражение из нашей формы: он нам больше не понадобится!

Мы также собираемся удалить атрибут `on` который в настоящее время используется для указания AMP показывать наши правила паролей. Как было сказано выше, вместо этого мы собираемся использовать `<amp-script>` для захвата события `focus` браузера.

```html
pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^a-z\d]).{8,}$"
on="tap:rules.show; input-debounced:rules.show"
```

Теперь убедимся, что наш `<amp-script>` работает. Откройте созданный вами файл `validate.js` и добавьте сообщение отладки:

```js
console.log("Hello, amp-script!");
```

Зайдите в свой браузер, откройте консоль и перезагрузите страницу. Убедитесь, что вы видите свое сообщение!

{{image ('/ static / img / docs / tutorials / custom-javascript-tutorial / hello-amp-script.png', 600, 22, layout = 'intrinsic', alt = 'Привет, сообщение amp-script в консоли » , align = 'center')}}

## Где мой JavaScript?

`<amp-script>` запускает ваш JavaScript в Web Worker. Веб-воркеры не могут получить доступ к DOM напрямую, поэтому `<amp-script>` дает воркеру доступ к виртуальной копии DOM, которую он синхронизирует с реальной DOM. `<amp-script>` обеспечивает эмуляцию многих распространенных API-интерфейсов DOM, почти все из которых вы можете использовать в своем JavaScript обычным способом.

Если в какой-то момент вам понадобится отладить сценарий, вы можете установить точки останова в JavaScript в Web Worker так же, как и в любом JavaScript. Вам просто нужно знать, где это найти.

В Chrome DevTools откройте вкладку «Источники». Внизу вы увидите длинную шестнадцатеричную строку, подобную показанной ниже. Разверните его, затем разверните область «без домена», и вы увидите свой сценарий:

{{image ('/ static / img / docs / tutorials / custom-javascript-tutorial / script-in-sources.png', 303, 277, layout = 'intrinsic', alt = 'amp-script JavaScript на панели источников DevTools ', align =' center ')}}

# Добавление нашего JavaScript

Теперь, когда мы знаем, что наш `<amp-script>` работает, давайте напишем немного JavaScript!

Первое, что мы хотим сделать, это захватить элементы DOM, с которыми мы будем работать, и спрятать их в глобальных объектах. Наш код будет использовать ввод пароля, кнопку отправки и область, которая показывает правила пароля. Добавьте эти три объявления в `validate.js` :

```js
const passwordBox = document.getElementById("passwordBox");
const submitButton = document.getElementById("submitButton");
const rulesArea = document.getElementById("rules");
```

Обратите внимание, что мы можем использовать обычные методы DOM API, такие как `getElementById()` . Хотя наш код выполняется в воркере, а у воркеров нет прямого доступа к DOM, `<amp-script>` предоставляет виртуальную копию DOM и эмулирует некоторые общие API, перечисленные [здесь](https://github.com/ampproject/worker-dom/blob/main/web_compat_table.md) . Эти API-интерфейсы предоставляют нам достаточно инструментов для большинства случаев использования. Но важно отметить, что поддерживается только подмножество DOM API. В противном случае JavaScript, включенный в `<amp-script>` был бы огромным, сводя на нет преимущества AMP в производительности!

Нам нужно добавить эти идентификаторы к двум элементам. Откройте `index.html` , найдите пароль `<input>` и кнопку submit `<button>` и добавьте идентификаторы. Добавьте также `disabled` атрибут в `<button>` submit, чтобы пользователь не нажимал на него, пока мы не захотим.

```html
<input type=password
       id="passwordBox"

...

<button type="submit" id="submitButton" tabindex="3" disabled>Submit</button>
```

Обновите страницу. Вы можете убедиться, что эти глобальные переменные были установлены правильно, проверив консоль, так же, как вы могли бы с нерабочим JavaScript:

{{image ('/ static / img / docs / tutorials / custom-javascript-tutorial / global-set.png', 563, 38, layout = 'intrinsic', alt = 'Сообщение консоли, показывающее, что submitButton установлен », align = 'center')}}

Мы также добавим идентификаторы к каждому `<li>` в `<div id="rules">` . Каждый из них содержит отдельное правило, цвет которого мы хотим контролировать. И мы удалим каждый экземпляр `class="invalid"` . Наш новый JavaScript добавит это при необходимости!

```html
<ul>
  <li id="lower">Lowercase letter</li>
  <li id="upper">Capital letter</li>
  <li id="digit">Digit</li>
  <li id="special">Special character (@$!%*?&)</li>
  <li id="eight">At least 8 characters long</li>
</ul>
```

## Реализация наших проверок паролей в JavaScript

Затем мы распакуем регулярные выражения из нашего атрибута `pattern` . Каждое регулярное выражение представляет одно из наших правил. Давайте добавим карту объектов в конец `validate.js` которая связывает каждое правило с проверяемым критерием.

```js
const checkRegexes = {
  lower: /[a-z]/,
  upper: /[A-Z]/,
  digit: /\d/,
  special: /[^a-zA-Z\d]/i,
  eight: /.{8}/
};
```

Установив эти глобальные переменные, мы готовы написать логику, которая проверяет пароль и соответствующим образом корректирует пользовательский интерфейс. Мы поместим нашу логику в функцию с названием `initCheckPassword` которая принимает единственный аргумент - элемент DOM пароля `<input>` . Этот подход удобно скрывает элемент DOM в закрытии.

```js
function initCheckPassword(element) {

}
```

Затем давайте `initCheckPassword` функциями и назначениями слушателей событий, которые нам понадобятся. Прежде всего, добавьте небольшую функцию, которая превращает отдельное правило `<li>` зеленый цвет, если правило проходит, и еще одну, которая превращает его в красный цвет в случае сбоя.

```js
function initCheckPassword(el) {
  const checkPass = (el) => {
    el.classList.remove("invalid");
    el.classList.add("valid");
  };

  const checkFail = (el) => {
    el.classList.remove("valid");
    el.classList.add("invalid");
  };
};
```

Давайте сделаем так, чтобы эти `valid` и `invalid` классы действительно стали текстовыми в зеленый или красный цвет. Вернитесь к `index.html` и добавьте эти два правила в `<style amp-custom>` :

```css
li.valid {
  color: #2d7b1f;
}

li.invalid {
  color:#c11136;
}
```

Теперь мы готовы добавить логику, которая проверяет содержимое пароля `<input>` на соответствие нашим правилам. Добавьте новую функцию `checkPassword()` в `initCheckPassword()` прямо перед закрывающей фигурной скобкой:

```js
const checkPassword = () => {
  const password = element.value;
  let failed = false;

  for (const check in checkRegexes) {
    let li = document.getElementById(check);

    if (password.match(checkRegexes[check])) {
      checkPass(li);
    } else {
      checkFail(li);
      failed = true;
    }
  }

  if (!failed) {
    submitButton.removeAttribute("disabled");
  }
};
```

Эта функция выполняет следующее:

1. Захватывает содержимое пароля `<input>` .
2. Создает флаг с именем `failed` , инициализированный значением `false` .
3. Обходит каждое из наших регулярных выражений и проверяет каждое на соответствие паролю:
    - If the password fails a test, call `checkFail()` to turn the corresponding rule red. Also, set `failed` to `true`.
    - Если пароль проходит проверку, вызовите `checkPass()` чтобы сделать соответствующее правило зеленым.
4. Наконец, если ни одно правило не сработало, пароль действителен, и мы активируем кнопку «Отправить».

Все, что нам сейчас нужно, это пара слушателей событий. Помните, как мы не могли использовать событие `focus` в AMP? В `<amp-script>` мы можем. Каждый раз, когда пароль `<input>` получает событие `focus` , мы отображаем правила. И всякий раз, когда пользователь нажимает клавишу в этом вводе, мы вызываем `checkPassword()` .

Добавьте эти два прослушивателя событий в `initCheckPassword()` непосредственно перед закрывающей фигурной скобкой:

```js
element.addEventListener("focus", () => rulesArea.removeAttribute("hidden"));
element.addEventListener("keyup", checkPassword);
```

Наконец, в самом конце `validate.js` добавьте строку, которая инициализирует `initCheckPassword` элементом DOM password `<input>` :

```js
initCheckPassword(passwordBox);
```

Наша логика завершена! Когда пароль соответствует всем нашим критериям, все правила будут зелеными, и наша кнопка отправки будет активирована. Теперь у вас должно быть такое взаимодействие:

<figure class="alignment-wrapper margin-"></figure><amp-video width="762" height="564" layout="responsive" autoplay="" loop="" noaudio=""></amp-video><source src="/static/img/docs/tutorials/custom-javascript-tutorial/finished-project.mp4" type="video/mp4"><source src="/static/img/docs/tutorials/custom-javascript-tutorial/finished-project.webm" type="video/webm"> Если вы застряли, вы всегда можете обратиться к рабочему коду в каталоге «finished_code».</source></source>

# Поздравляю!

Вы узнали, как использовать `<amp-script>` для написания собственного JavaScript в AMP. Вам удалось усовершенствовать компонент `<amp-form>` с помощью вашей собственной логики и функций пользовательского интерфейса! Не стесняйтесь добавлять на свою новую страницу больше функций! А чтобы узнать больше о `<amp-script>` , обратитесь [к справочной документации](../../../documentation/components/reference/amp-script.md) .
